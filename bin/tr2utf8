#!/usr/bin/env node

'use strict';

const path = require('path'),
    fs = require('fs'),
    yargs = require('yargs'),
    updateNotifier = require('update-notifier'),
    turkishCharEncoding = require('turkish-char-encoding'),
    pkg = require('../package.json');

let exitCode = 0;

process.on('uncaughtException', function (err) {
    console.error(err.stack);
    exitCode = 1;
});

process.on('exit', function () {
    process.exit(exitCode);
});

updateNotifier({ pkg: pkg })
    .notify({ defer: false });

const argv = yargs
    .usage('Usage: $0 <file> [options]')
    .version(pkg.version)
    .demand(1, 'must provide a filename')
    .option('bom', {
        alias: 'b',
        describe: 'write byte order mark to beginning of the file',
        default: false
    })
    .option('target', {
        alias: 't',
        describe: 'set target file'
    })
    .option('encoding', {
        alias: 'e',
        describe: 'set source encoding',
        default: 'win-1254',
        choices: ['win-1254', 'iso-8859-9', 'iso-8859-1']
    })
    .alias('v', 'version')
    .help('h')
    .alias('h', 'help')
    .example('$0 source.txt', 'Converts source.txt into utf-8')
    .example('$0 source.txt --bom', 'Converts source.txt into utf-8 with BOM (byte order mark)')
    .example('$0 source.txt --target target.txt', 'Reads from source.txt, writes utf-8 converted version as target.txt')
    .example('$0 source.txt --encoding iso-8859-9', 'Converts ISO-8859-9 encoded source.txt into utf-8')
    .argv;

const sourceFile = argv._[0],
    targetFile = argv.target || sourceFile;

const content = fs.readFileSync(sourceFile, 'binary');

const convertedContent = // (argv.bom) ? '\ufeff' : '' +
    turkishCharEncoding(argv.encoding).toUTF8(content);

fs.writeFileSync(targetFile, convertedContent, { encoding: 'utf-8' });

console.log('done.');
